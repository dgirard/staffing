# Sp√©cification Compl√®te - Outil de Staffing ESN
## Solution Moderne, √âconomique et Intelligente

---

## üìã SOMMAIRE EX√âCUTIF

### Vision
Outil de staffing nouvelle g√©n√©ration pour ESN de 50 personnes, combinant **simplicit√© d'usage**, **co√ªts ma√Ætris√©s** et **intelligence conversationnelle** pour maximiser le taux d'activit√© (objectif 70-75%) et la rentabilit√© des projets.

### Approche Diff√©renciante

**üéØ Saisie simplifi√©e** : Temps saisi √† la **demi-journ√©e** (matin/apr√®s-midi) au lieu d'heures
- Saisie hebdomadaire en **30 secondes** (vs 5 minutes)
- Interface mobile optimale (PWA)
- Moins d'erreurs, plus d'adoption

**üí¨ Interface conversationnelle** : Chat aliment√© par IA pour **80% des actions courantes**
- "Saisi 1 jour projet X aujourd'hui"
- "Valider tous les timesheets"
- "Quelle est la marge r√©elle du projet Y ?"

**üîê Double syst√®me de co√ªts** : CJR (r√©el) + CJN (norm√©)
- **CJR** (Co√ªt Journalier R√©el) : Salaire r√©el ‚Üí Directeurs uniquement
- **CJN** (Co√ªt Journalier Norm√©) : Grille standard ‚Üí Tous les autres
- Confidentialit√© totale des salaires

**‚òÅÔ∏è Architecture Cloudflare** : Serverless ultra-√©conomique
- H√©bergement : **7-12‚Ç¨/mois** (vs 500-2000‚Ç¨ cloud traditionnel)
- Performance : Edge computing global
- Scalabilit√© : Auto-scaling sans configuration

**üîå Int√©gration MCP** : Model Context Protocol pour connexion externe
- Utilisable depuis Claude, ChatGPT, etc.
- API REST moderne et document√©e
- Automatisation pouss√©e

### Chiffres Cl√©s

| M√©trique | Valeur |
|----------|--------|
| **Budget d√©veloppement** | 38 200‚Ç¨ (60 jours-personne) |
| **Co√ªt h√©bergement/mois** | 7-12‚Ç¨ |
| **D√©lai de livraison** | 3 mois (5 sprints) |
| **ROI Ann√©e 1** | 228% |
| **Payback** | 5.3 mois |
| **Gains annuels** | 87 250‚Ç¨ |

### Personas

1. **Consultant** : Saisit son temps (web + mobile), consulte ses projets
2. **Project Owner** : Valide timesheets, pilote budgets projets (CJN)
3. **Administrator** : G√®re allocations, capacit√© globale (CJN)
4. **Directeur** : Vision financi√®re compl√®te avec acc√®s CJR

### Technologies

- **Frontend** : React 18 PWA (Cloudflare Pages)
- **API** : Hono + Cloudflare Workers
- **Database** : Cloudflare D1 (SQLite distribu√©)
- **IA** : Google Gemini API (cl√© stock√©e dans Cloudflare Secrets)
- **Mobile** : PWA offline-capable

---

## Vue d'ensemble strat√©gique

**Objectif** : Outil de staffing moderne pour ESN de 50 personnes, maximisant le taux d'activit√© (70-75%) avec une approche **lean** et **√©conomique**.

**Contraintes critiques** :
- **Budget** : 60 jours-personne (1 d√©veloppeur full-stack)
- **Co√ªt h√©bergement** : 7-12‚Ç¨/mois (Cloudflare)
- **D√©lai** : 3 mois de d√©veloppement
- **Architecture** : Serverless, API-first, conversationnelle

**Diff√©renciateurs** :
- ‚úÖ Saisie temps √† la **demi-journ√©e** (ultra-rapide)
- ‚úÖ Interface conversationnelle (chat) pour 80% des actions
- ‚úÖ MCP (Model Context Protocol) pour int√©gration externe
- ‚úÖ PWA mobile-first pour saisie terrain
- ‚úÖ Architecture Cloudflare ultra-√©conomique
- ‚úÖ Gestion fine des co√ªts (CJR/CJN) avec confidentialit√©

---

## üìö TABLE DES MATI√àRES

1. [PERSONAS & PERMISSIONS](#1-personas--permissions-4-types)
2. [GESTION DES CO√õTS : CJR vs CJN](#2-gestion-des-co√ªts--cjr-vs-cjn)
3. [ARCHITECTURE CLOUDFLARE](#3-architecture-cloudflare-ultra-√©conomique)
4. [INTERFACE CONVERSATIONNELLE (CHAT)](#4-interface-conversationnelle-chat)
5. [MCP (MODEL CONTEXT PROTOCOL)](#5-mcp-model-context-protocol)
6. [MOD√àLE DE DONN√âES](#6-mod√®le-de-donn√©es-simplifi√©)
7. [SAISIE TEMPS √Ä LA DEMI-JOURN√âE](#7-saisie-temps-√†-la-demi-journ√©e)
8. [API REST](#8-api-rest-hono--workers)
9. [ROADMAP 60 JOURS](#9-roadmap-60-jours)
10. [FONCTIONNALIT√âS PAR PERSONA](#10-fonctionnalit√©s-par-persona-prioris√©es)
11. [CRIT√àRES DE SUCC√àS](#11-crit√®res-de-succ√®s)
12. [COMPARAISON VERSIONS](#12-diff√©rences-vs-spec-v1)
13. [RISQUES & MITIGATIONS](#13-risques--mitigation)
14. [PROCHAINES √âTAPES](#14-prochaines-√©tapes)
15. [CONCLUSION](#15-conclusion)

---

## 1. PERSONAS & PERMISSIONS (4 types)

### 1.1 Consultant
**Acc√®s** : Ses donn√©es uniquement
- ‚úÖ Saisir temps (web + mobile PWA)
- ‚úÖ Voir ses projets et allocations
- ‚úÖ Consulter son utilisation (bas√©e sur CJN masqu√©)
- ‚úÖ Demander cong√©s
- ‚úÖ **Chat** : "Combien d'heures j'ai fait cette semaine ?", "Sur quels projets je suis ?"

**Visibilit√© co√ªts** : AUCUNE (ni CJR ni CJN)

### 1.2 Project Owner
**Acc√®s** : Ses projets et consultants assign√©s
- ‚úÖ Valider timesheets
- ‚úÖ Suivre budget projet (bas√© sur **CJN**)
- ‚úÖ Voir marges projet (TJ - CJN)
- ‚úÖ **Chat** : "Valider les timesheets en attente", "Budget restant projet X ?"

**Visibilit√© co√ªts** : **CJN uniquement** (anonymis√©)

### 1.3 Administrator
**Acc√®s** : Tous les projets et consultants
- ‚úÖ Cr√©er projets, affecter consultants
- ‚úÖ G√©rer allocations et conflits
- ‚úÖ Dashboard capacit√© et utilisation (bas√© sur **CJN**)
- ‚úÖ Exports et rapports (avec CJN)
- ‚úÖ **Chat** : "Qui est disponible en React ?", "Cr√©er projet X avec consultant Y"

**Visibilit√© co√ªts** : **CJN uniquement**

### 1.4 **Directeur** (NOUVEAU)
**Acc√®s** : Tous les projets, consultants + donn√©es financi√®res r√©elles
- ‚úÖ Toutes les fonctions Administrator
- ‚úÖ Acc√®s **CJR** (co√ªt salarial r√©el) de tous les consultants
- ‚úÖ Marges r√©elles (TJ - CJR) par projet/consultant
- ‚úÖ Analyse P&L avec co√ªts r√©els
- ‚úÖ Dashboard financier direction
- ‚úÖ **Chat** : "Quelle est la marge r√©elle du projet X ?", "Top 5 consultants par rentabilit√© r√©elle"

**Visibilit√© co√ªts** : **CJR + CJN** (acc√®s total)

**S√©curit√© renforc√©e** :
- MFA obligatoire pour Directeur
- Audit log toutes consultations CJR
- Session timeout 15min (vs 1h autres r√¥les)

---

## 2. GESTION DES CO√õTS : CJR vs CJN

### 2.1 D√©finitions

#### CJR - Co√ªt Journalier R√©el
**D√©finition** : Co√ªt r√©el entreprise par jour travaill√©, bas√© sur le **salaire individuel**

```
CJR = (Salaire brut annuel + Charges 45% + Avantages + √âquipement) / 210 jours

Exemple Consultant Junior :
- Salaire brut : 35 000 ‚Ç¨
- Charges (45%) : 15 750 ‚Ç¨
- Avantages : 2 000 ‚Ç¨
- √âquipement : 1 500 ‚Ç¨
- Total annuel : 54 250 ‚Ç¨
- CJR = 54 250 / 210 = 258 ‚Ç¨/jour
```

**Confidentialit√©** : CRITIQUE - Accessible **uniquement aux Directeurs**

#### CJN - Co√ªt Journalier Norm√©
**D√©finition** : Co√ªt standard par profil/seniority, **d√©connect√© du salaire r√©el**

```
Grille standard CJN :
- Junior (0-2 ans)     : 300 ‚Ç¨/j
- Consultant (2-5 ans) : 400 ‚Ç¨/j
- Senior (5-10 ans)    : 550 ‚Ç¨/j
- Manager (10+ ans)    : 700 ‚Ç¨/j
- Directeur            : 900 ‚Ç¨/j
```

**Usage** : Calculs marges pour Project Owners et Administrators

### 2.2 Cas d'usage

| Calcul | Project Owner | Administrator | Directeur |
|--------|---------------|---------------|-----------|
| Marge projet | TJ - CJN | TJ - CJN | **TJ - CJR** (r√©el) |
| Rentabilit√© consultant | ‚ùå Aucune | TJ - CJN (norm√©) | **TJ - CJR** (r√©el) |
| P&L consolid√© | ‚ùå | Estim√© (CJN) | **R√©el (CJR)** |
| Forecast rentabilit√© | TJ - CJN | TJ - CJN | **TJ - CJR** |

### 2.3 Avantages du double syst√®me

**Pour l'entreprise** :
- ‚úÖ Confidentialit√© salaires pr√©serv√©e
- ‚úÖ Project Owners peuvent g√©rer sans voir salaires
- ‚úÖ Direction a vision financi√®re r√©elle
- ‚úÖ D√©tection √©carts CJR vs CJN (consultants sur/sous-pay√©s)

**Pour les calculs** :
- ‚úÖ CJN = outil de gestion quotidien (80% usages)
- ‚úÖ CJR = pilotage financier strat√©gique (20% usages)

### 2.4 Impl√©mentation technique

```typescript
// Mod√®le de donn√©es
interface Consultant {
  consultant_id: string;
  // ... autres champs
  cjn: number;              // Visible Admins + Directeurs
  cjr: number;              // Visible Directeurs UNIQUEMENT
  profil_seniority: 'junior' | 'consultant' | 'senior' | 'manager' | 'directeur';
}

// Middleware de s√©curit√©
function getConsultantCost(consultant: Consultant, userRole: Role): number {
  if (userRole === 'directeur') {
    return consultant.cjr; // Co√ªt r√©el
  }
  if (userRole === 'administrator' || userRole === 'project_owner') {
    return consultant.cjn; // Co√ªt norm√©
  }
  throw new Error('Unauthorized'); // Consultants n'ont pas acc√®s
}

// Audit automatique
async function auditCJRAccess(userId: string, consultantId: string) {
  await db.audit.create({
    user_id: userId,
    action: 'VIEW_CJR',
    entity_id: consultantId,
    timestamp: new Date(),
    ip_address: getClientIP()
  });
}
```

---

## 3. ARCHITECTURE CLOUDFLARE (ULTRA-√âCONOMIQUE)

### 3.1 Stack Cloudflare

**Frontend** : Cloudflare Pages
- React 18 + TypeScript + Vite
- PWA avec Service Worker
- CDN global automatique
- **Co√ªt** : 0‚Ç¨ (free tier : illimit√©)

**API** : Cloudflare Workers
- Hono (framework ultra-l√©ger, 12kb)
- TypeScript natif
- Auto-scaling automatique
- **Co√ªt** : 5‚Ç¨/mois (plan Workers Paid : 10M requ√™tes)

**Base de donn√©es** : Cloudflare D1
- SQLite distribu√© (serverless)
- Backups automatiques
- 10GB gratuit puis 0.75$/GB
- **Co√ªt** : 0-3‚Ç¨/mois (50 users = ~2GB)

**Stockage fichiers** : Cloudflare R2
- S3-compatible
- 10GB gratuit
- **Co√ªt** : 0‚Ç¨ (exports, docs < 10GB)

**Background Jobs** : Cloudflare Queues
- Agr√©gations nuit, emails
- **Co√ªt** : 0‚Ç¨ (free tier : 1M/mois)

**Cache** : Workers KV
- Sessions, config
- **Co√ªt** : 0‚Ç¨ (free tier)

**AI/Chat** : Google Gemini API
- LLM via API externe (Gemini Pro)
- Cl√© stock√©e dans Cloudflare Secrets (s√©curis√© et chiffr√©)
- Interface conversationnelle
- **Co√ªt** : Free tier Gemini (60 req/min) puis ~0.0005$/1000 chars (~1-2‚Ç¨/mois)

**TOTAL MENSUEL** : **7-12‚Ç¨/mois** (vs 500-2000‚Ç¨ AWS/Azure)

### 3.2 Architecture globale

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    Cloudflare Pages (Frontend)               ‚îÇ
‚îÇ   - PWA React (mobile + web)                                ‚îÇ
‚îÇ   - Chat UI conversationnel                                 ‚îÇ
‚îÇ   - Service Worker (offline)                                ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚Üì HTTPS
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ              Cloudflare Workers (API Gateway)                ‚îÇ
‚îÇ   - Hono Router                                             ‚îÇ
‚îÇ   - JWT Auth                                                ‚îÇ
‚îÇ   - RBAC middleware                                         ‚îÇ
‚îÇ   - Rate limiting                                           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
        ‚Üì               ‚Üì              ‚Üì              ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Gemini API  ‚îÇ ‚îÇ  D1 SQLite ‚îÇ ‚îÇ Workers KV ‚îÇ ‚îÇ Queues       ‚îÇ
‚îÇ  (Chat LLM)  ‚îÇ ‚îÇ  (Core DB) ‚îÇ ‚îÇ (Sessions) ‚îÇ ‚îÇ (Jobs async) ‚îÇ
‚îÇ  + Secrets   ‚îÇ ‚îÇ            ‚îÇ ‚îÇ            ‚îÇ ‚îÇ              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### 3.3 Avantages Cloudflare

‚úÖ **Co√ªt** : 95% moins cher que cloud traditionnel
‚úÖ **Performance** : Edge computing (< 50ms latence)
‚úÖ **Scalabilit√©** : Auto-scale sans config
‚úÖ **Simplicit√©** : Pas de DevOps complexe
‚úÖ **S√©curit√©** : DDoS protection incluse
‚úÖ **Global** : 300+ datacenters

---

## 4. INTERFACE CONVERSATIONNELLE (CHAT)

### 4.1 Principe

**80% des actions courantes** via chat en langage naturel :

**Exemples Consultant** :
- "Combien de jours j'ai fait cette semaine ?"
- "Saisi 1 jour sur projet X aujourd'hui"
- "Matin projet Alpha, apr√®s-midi projet Beta"
- "Quelle est mon utilisation ce mois ?"
- "Quand finit ma mission sur projet Y ?"

**Exemples Project Owner** :
- "Valider tous les timesheets en attente"
- "Quel est le budget restant sur projet X ?"
- "Qui travaille sur mes projets cette semaine ?"
- "Rejeter timesheet de Jean avec message : incoh√©rent"

**Exemples Administrator** :
- "Qui est disponible la semaine prochaine en React ?"
- "Cr√©er projet ABC avec consultant Marie √† 50%"
- "Afficher les conflits d'allocation"
- "Quel est le taux d'utilisation global ?"

**Exemples Directeur** :
- "Quelle est la marge r√©elle du projet X ?"
- "Top 5 consultants par rentabilit√© r√©elle"
- "√âcart moyen entre CJN et CJR par profil"
- "P&L r√©el du mois dernier"

### 4.2 Architecture Chat

```typescript
// Chat Worker avec Google Gemini API
interface ChatMessage {
  role: 'user' | 'assistant' | 'system';
  content: string;
}

async function handleChat(request: Request, env: Env) {
  const { message, userId } = await request.json();

  // Context utilisateur
  const user = await getUser(userId);
  const systemPrompt = buildSystemPrompt(user.role);

  // D√©tection d'intention
  const intent = await detectIntent(message);

  // Ex√©cution action
  const result = await executeAction(intent, user);

  // G√©n√©ration r√©ponse naturelle avec Gemini
  const geminiResponse = await fetch(
    `https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${env.GEMINI_API_KEY}`,
    {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        contents: [{
          parts: [{
            text: `${systemPrompt}\n\nUser: ${message}\n\nData: ${JSON.stringify(result)}\n\nR√©ponds de mani√®re naturelle et concise.`
          }]
        }],
        generationConfig: { temperature: 0.7, maxOutputTokens: 800 }
      })
    }
  );

  const geminiData = await geminiResponse.json();
  const response = geminiData.candidates?.[0]?.content?.parts?.[0]?.text || 'Erreur';

  return new Response(JSON.stringify({ response, data: result }));
}

// Intentions support√©es
type Intent = 
  | 'TIMESHEET_QUERY'
  | 'TIMESHEET_CREATE'
  | 'TIMESHEET_VALIDATE'
  | 'PROJECT_QUERY'
  | 'ALLOCATION_QUERY'
  | 'BUDGET_QUERY'
  | 'MARGE_QUERY'      // Directeur uniquement
  | 'CJR_QUERY'        // Directeur uniquement
  | 'HELP';

// Exemples prompts syst√®me par r√¥le
const SYSTEM_PROMPTS = {
  consultant: `Tu es un assistant pour consultant en ESN. 
    Tu peux aider √† : saisir le temps, consulter allocations, voir utilisation.
    R√©ponds de mani√®re concise et actionnable.`,
  
  directeur: `Tu es un assistant pour Directeur d'ESN.
    Tu as acc√®s aux donn√©es financi√®res sensibles (CJR, marges r√©elles).
    Sois pr√©cis avec les chiffres et maintiens la confidentialit√©.`
};
```

### 4.3 UI Chat

**Interface** :
- Chat persistant (coin bas-droit)
- Historique conversations (D1)
- Suggestions rapides (quick actions)
- R√©sultats riches (tables, graphiques)
- Fallback vers formulaires classiques

**Exemples UI** :

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ üí¨ Assistant Staffing               ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ Consultant: "Combien d'heures cette ‚îÇ
‚îÇ             semaine ?"              ‚îÇ
‚îÇ                                     ‚îÇ
‚îÇ Assistant: Vous avez saisi 32h     ‚îÇ
‚îÇ            cette semaine :          ‚îÇ
‚îÇ            ‚Ä¢ Projet Alpha: 24h      ‚îÇ
‚îÇ            ‚Ä¢ Projet Beta: 8h        ‚îÇ
‚îÇ            Il vous reste 8h √† saisir‚îÇ
‚îÇ                                     ‚îÇ
‚îÇ [Saisir temps] [Voir d√©tails]      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### 4.4 Actions rapides pr√©-d√©finies

**Consultant** :
- ‚ö° Copier semaine derni√®re
- ‚ö° Saisir 8h aujourd'hui
- ‚ö° Soumettre timesheet
- ‚ö° Voir mes projets

**Project Owner** :
- ‚ö° Valider tout en attente
- ‚ö° Budget mes projets
- ‚ö° Timesheets non soumis

**Directeur** :
- ‚ö° Marges r√©elles top 5 projets
- ‚ö° CJR vs CJN √©carts
- ‚ö° P&L mois en cours

---

## 5. MCP (MODEL CONTEXT PROTOCOL)

### 5.1 Qu'est-ce que MCP ?

**MCP** = Protocol pour connecter des LLM (Claude, GPT, etc.) √† des sources de donn√©es externes.

**Cas d'usage** :
- Utiliser Claude Desktop/API pour interagir avec l'outil staffing
- "Claude, saisis 8h sur projet X pour moi aujourd'hui"
- "Claude, g√©n√®re un rapport de marge pour tous mes projets"

### 5.2 Serveur MCP Cloudflare

```typescript
// mcp-server.ts - Cloudflare Worker
import { Server } from '@modelcontextprotocol/sdk/server';

const server = new Server({
  name: 'staffing-tool',
  version: '1.0.0'
});

// Outils expos√©s via MCP
server.setRequestHandler('tools/list', async () => ({
  tools: [
    {
      name: 'get_timesheet',
      description: 'R√©cup√®re le timesheet d\'un consultant',
      inputSchema: {
        type: 'object',
        properties: {
          consultant_id: { type: 'string' },
          week: { type: 'string', format: 'date' }
        }
      }
    },
    {
      name: 'create_time_entry',
      description: 'Cr√©e une saisie de temps',
      inputSchema: {
        type: 'object',
        properties: {
          project_id: { type: 'string' },
          hours: { type: 'number' },
          date: { type: 'string', format: 'date' }
        }
      }
    },
    {
      name: 'get_project_margin',
      description: 'Calcule la marge d\'un projet (Directeur uniquement)',
      inputSchema: {
        type: 'object',
        properties: {
          project_id: { type: 'string' },
          use_real_cost: { type: 'boolean' } // CJR si true
        }
      }
    }
  ]
}));

// Ex√©cution outils
server.setRequestHandler('tools/call', async (request) => {
  const { name, arguments: args } = request.params;
  
  // V√©rification auth (JWT token)
  const user = await authenticateFromMCP(request);
  
  switch (name) {
    case 'get_timesheet':
      return await getTimesheet(args.consultant_id, args.week, user);
    
    case 'create_time_entry':
      return await createTimeEntry(args, user);
    
    case 'get_project_margin':
      // Check role Directeur pour CJR
      if (args.use_real_cost && user.role !== 'directeur') {
        throw new Error('Unauthorized: CJR access requires Directeur role');
      }
      return await getProjectMargin(args.project_id, args.use_real_cost, user);
  }
});
```

### 5.3 Configuration Claude Desktop

```json
// claude_desktop_config.json
{
  "mcpServers": {
    "staffing": {
      "url": "https://staffing-mcp.votre-domain.workers.dev",
      "apiKey": "YOUR_API_KEY",
      "headers": {
        "Authorization": "Bearer YOUR_JWT_TOKEN"
      }
    }
  }
}
```

### 5.4 Exemples d'usage

**Consultant avec Claude** :
```
User: Claude, peux-tu saisir 8h sur le projet "Refonte Site" pour aujourd'hui ?

Claude: [Appelle create_time_entry via MCP]
       J'ai saisi 8 heures sur le projet "Refonte Site" pour aujourd'hui.
       Total semaine : 32h. Il reste 8h √† saisir.
```

**Directeur avec Claude** :
```
User: Claude, quelle est la marge r√©elle du projet Alpha ?

Claude: [Appelle get_project_margin avec use_real_cost=true via MCP]
        Projet Alpha - Marge r√©elle :
        ‚Ä¢ CA factur√© : 125 000 ‚Ç¨
        ‚Ä¢ Co√ªts r√©els (CJR) : 78 500 ‚Ç¨
        ‚Ä¢ Marge brute : 46 500 ‚Ç¨ (37.2%)
        ‚Ä¢ Co√ªts norm√©s (CJN) : 85 000 ‚Ç¨
        ‚Ä¢ √âcart CJR vs CJN : -6 500 ‚Ç¨ (consultants sous-pay√©s vs grille)
```

---

## 6. MOD√àLE DE DONN√âES SIMPLIFI√â

### 6.1 Sch√©ma D1 SQLite (8 tables core)

```sql
-- USERS (authentification + r√¥les)
CREATE TABLE users (
  user_id TEXT PRIMARY KEY,
  email TEXT UNIQUE NOT NULL,
  password_hash TEXT NOT NULL,
  role TEXT CHECK(role IN ('consultant', 'project_owner', 'administrator', 'directeur')),
  created_at INTEGER NOT NULL
);

-- CONSULTANTS (profils + co√ªts)
CREATE TABLE consultants (
  consultant_id TEXT PRIMARY KEY,
  user_id TEXT UNIQUE REFERENCES users(user_id),
  nom TEXT NOT NULL,
  prenom TEXT NOT NULL,
  profil_seniority TEXT CHECK(profil_seniority IN ('junior', 'consultant', 'senior', 'manager', 'directeur')),
  cjn REAL NOT NULL,              -- Co√ªt Journalier Norm√© (visible Admins)
  cjr REAL NOT NULL,              -- Co√ªt Journalier R√©el (visible Directeurs SEULEMENT)
  date_embauche TEXT,
  statut TEXT DEFAULT 'actif'
);
CREATE INDEX idx_consultants_statut ON consultants(statut);

-- PROJECTS
CREATE TABLE projects (
  project_id TEXT PRIMARY KEY,
  code_projet TEXT UNIQUE NOT NULL,
  nom_projet TEXT NOT NULL,
  client TEXT,
  type_projet TEXT CHECK(type_projet IN ('regie', 'forfait')), -- Simplifi√©
  montant_vendu REAL,
  jours_vendus INTEGER,
  date_debut TEXT,
  date_fin TEXT,
  statut TEXT DEFAULT 'actif',
  owner_id TEXT REFERENCES users(user_id)  -- Project Owner
);
CREATE INDEX idx_projects_owner ON projects(owner_id);
CREATE INDEX idx_projects_statut ON projects(statut);

-- PERSONAS (r√¥les facturables)
CREATE TABLE personas (
  persona_id TEXT PRIMARY KEY,
  code TEXT UNIQUE NOT NULL,
  libelle TEXT NOT NULL,
  tj_reference REAL NOT NULL  -- TJ moyen pour ce r√¥le
);

-- INTERVENTIONS (allocations)
CREATE TABLE interventions (
  intervention_id TEXT PRIMARY KEY,
  consultant_id TEXT REFERENCES consultants(consultant_id),
  project_id TEXT REFERENCES projects(project_id),
  persona_id TEXT REFERENCES personas(persona_id),
  tj_verrouille REAL NOT NULL,  -- TJ fix√© √† l'allocation
  allocation_pct INTEGER CHECK(allocation_pct >= 0 AND allocation_pct <= 100),
  date_debut TEXT NOT NULL,
  date_fin TEXT,
  statut TEXT DEFAULT 'active'
);
CREATE INDEX idx_interventions_consultant ON interventions(consultant_id, statut);
CREATE INDEX idx_interventions_project ON interventions(project_id);

-- TIME_ENTRIES (saisie temps √† la demi-journ√©e)
CREATE TABLE time_entries (
  time_entry_id TEXT PRIMARY KEY,
  consultant_id TEXT REFERENCES consultants(consultant_id),
  intervention_id TEXT REFERENCES interventions(intervention_id),
  project_id TEXT REFERENCES projects(project_id),
  entry_date TEXT NOT NULL,
  periode TEXT CHECK(periode IN ('matin', 'apres_midi', 'journee')) NOT NULL,  -- NOUVEAU : granularit√© demi-journ√©e
  jours REAL CHECK(jours IN (0.5, 1.0)) NOT NULL,  -- NOUVEAU : 0.5 ou 1.0 jour seulement
  statut TEXT CHECK(statut IN ('draft', 'submitted', 'validated', 'rejected')) DEFAULT 'draft',
  validated_by TEXT REFERENCES users(user_id),
  validated_at INTEGER,
  commentaire TEXT,
  created_at INTEGER NOT NULL
);
-- Contrainte : pas de double saisie m√™me p√©riode m√™me jour
CREATE UNIQUE INDEX idx_time_entries_unique ON time_entries(consultant_id, intervention_id, entry_date, periode);
CREATE INDEX idx_time_entries_consultant_date ON time_entries(consultant_id, entry_date DESC);
CREATE INDEX idx_time_entries_project_date ON time_entries(project_id, entry_date DESC);
CREATE INDEX idx_time_entries_statut ON time_entries(statut);

-- AUDIT_LOGS (tra√ßabilit√© acc√®s CJR)
CREATE TABLE audit_logs (
  audit_id TEXT PRIMARY KEY,
  user_id TEXT REFERENCES users(user_id),
  action TEXT NOT NULL,
  entity_type TEXT,
  entity_id TEXT,
  details TEXT,  -- JSON
  ip_address TEXT,
  created_at INTEGER NOT NULL
);
CREATE INDEX idx_audit_user_date ON audit_logs(user_id, created_at DESC);
CREATE INDEX idx_audit_action ON audit_logs(action);

-- CHAT_HISTORY (historique conversations)
CREATE TABLE chat_history (
  chat_id TEXT PRIMARY KEY,
  user_id TEXT REFERENCES users(user_id),
  messages TEXT NOT NULL,  -- JSON array
  created_at INTEGER NOT NULL,
  updated_at INTEGER NOT NULL
);
CREATE INDEX idx_chat_user_date ON chat_history(user_id, created_at DESC);
```

### 6.2 Vues calcul√©es (performances)

```sql
-- Vue utilisation consultants (avec CJN pour Admins, sans co√ªt pour Consultants)
CREATE VIEW v_consultant_utilization AS
SELECT 
  c.consultant_id,
  c.nom,
  c.prenom,
  c.profil_seniority,
  c.cjn,  -- Visible seulement si user.role IN ('administrator', 'directeur')
  COUNT(DISTINCT i.intervention_id) as nb_projets_actifs,
  SUM(CASE WHEN te.statut = 'validated' THEN te.jours ELSE 0 END) as jours_valides,
  -- Taux utilisation bas√© sur jours travaill√©s (21 jours ouvr√©s/mois en moyenne)
  ROUND(SUM(CASE WHEN te.statut = 'validated' THEN te.jours ELSE 0 END) * 100.0 / 21, 1) as taux_utilisation_30j
FROM consultants c
LEFT JOIN interventions i ON c.consultant_id = i.consultant_id AND i.statut = 'active'
LEFT JOIN time_entries te ON i.intervention_id = te.intervention_id 
  AND te.entry_date >= date('now', '-30 days')
GROUP BY c.consultant_id;

-- Vue marges projets (CJN pour Owners/Admins, CJR pour Directeurs)
CREATE VIEW v_project_margins AS
SELECT 
  p.project_id,
  p.code_projet,
  p.nom_projet,
  p.montant_vendu,
  p.jours_vendus,
  SUM(te.jours * i.tj_verrouille) as ca_realise,
  SUM(te.jours * c.cjn) as cout_cjn,  -- Co√ªt norm√©
  SUM(te.jours * c.cjr) as cout_cjr,  -- Co√ªt r√©el (Directeur only)
  SUM(te.jours * i.tj_verrouille) - SUM(te.jours * c.cjn) as marge_cjn,
  SUM(te.jours * i.tj_verrouille) - SUM(te.jours * c.cjr) as marge_cjr,
  ROUND((SUM(te.jours * i.tj_verrouille) - SUM(te.jours * c.cjn)) * 100.0 / 
    NULLIF(SUM(te.jours * i.tj_verrouille), 0), 1) as marge_pct_cjn,
  ROUND((SUM(te.jours * i.tj_verrouille) - SUM(te.jours * c.cjr)) * 100.0 / 
    NULLIF(SUM(te.jours * i.tj_verrouille), 0), 1) as marge_pct_cjr
FROM projects p
LEFT JOIN interventions i ON p.project_id = i.project_id
LEFT JOIN time_entries te ON i.intervention_id = te.intervention_id AND te.statut = 'validated'
LEFT JOIN consultants c ON i.consultant_id = c.consultant_id
GROUP BY p.project_id;
```

---

## 7. SAISIE TEMPS √Ä LA DEMI-JOURN√âE

### 7.1 Principe

**Granularit√©** : Les consultants saisissent leur temps par **demi-journ√©e** (matin / apr√®s-midi)

**Valeurs possibles** :
- ‚òÄÔ∏è **Matin uniquement** = 0.5 jour
- üåô **Apr√®s-midi uniquement** = 0.5 jour  
- üìÖ **Journ√©e compl√®te** = 1.0 jour

**Avantages** :
- ‚úÖ Saisie ultra-rapide (2 clics max)
- ‚úÖ Moins de d√©bats sur heures exactes
- ‚úÖ Interface mobile optimale
- ‚úÖ Align√© avec pratiques ESN fran√ßaises
- ‚úÖ Calculs simplifi√©s
- ‚úÖ Validation plus rapide

### 7.2 R√®gles m√©tier

**Contraintes par jour** :
- Maximum **2 saisies par jour** (1 matin + 1 apr√®s-midi)
- Maximum **1 jour total** par date
- Multi-projets autoris√© : 0.5j Projet A matin + 0.5j Projet B apr√®s-midi

**Exemples valides** :
```
Lundi 6 janvier :
- Matin : Projet Alpha (0.5j)
- Apr√®s-midi : Projet Alpha (0.5j)
‚Üí Total : 1 jour sur Projet Alpha ‚úÖ

Mardi 7 janvier :
- Matin : Projet Alpha (0.5j)
- Apr√®s-midi : Projet Beta (0.5j)
‚Üí Total : 0.5j Alpha + 0.5j Beta ‚úÖ

Mercredi 8 janvier :
- Journ√©e : Projet Alpha (1j)
‚Üí Total : 1 jour sur Projet Alpha ‚úÖ
```

**Exemples invalides** :
```
Jeudi 9 janvier :
- Journ√©e : Projet Alpha (1j)
- Apr√®s-midi : Projet Beta (0.5j)
‚Üí ERREUR : d√©passement 1.5j > 1j max ‚ùå

Vendredi 10 janvier :
- Matin : Projet Alpha (0.5j)
- Matin : Projet Beta (0.5j)
‚Üí ERREUR : 2 saisies sur m√™me p√©riode ‚ùå
```

### 7.3 Interface Web (Desktop)

**Vue Calendrier Hebdomadaire** :

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Semaine du 6 au 10 janvier 2025                [Soumettre]     ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ          ‚îÇ   Lun    ‚îÇ   Mar    ‚îÇ   Mer    ‚îÇ   Jeu    ‚îÇ   Ven    ‚îÇ
‚îÇ          ‚îÇ    6     ‚îÇ    7     ‚îÇ    8     ‚îÇ    9     ‚îÇ   10     ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ üåÖ Matin ‚îÇ          ‚îÇ          ‚îÇ          ‚îÇ          ‚îÇ          ‚îÇ
‚îÇ          ‚îÇ [Projet‚ñº]‚îÇ [Projet‚ñº]‚îÇ [Projet‚ñº]‚îÇ [Projet‚ñº]‚îÇ [Projet‚ñº]‚îÇ
‚îÇ Projet   ‚îÇ  Alpha   ‚îÇ  Alpha   ‚îÇ  Alpha   ‚îÇ  Beta    ‚îÇ  Alpha   ‚îÇ
‚îÇ Alpha    ‚îÇ   0.5j   ‚îÇ   0.5j   ‚îÇ          ‚îÇ   0.5j   ‚îÇ   0.5j   ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ üåá A-M   ‚îÇ          ‚îÇ          ‚îÇ          ‚îÇ          ‚îÇ          ‚îÇ
‚îÇ          ‚îÇ [Projet‚ñº]‚îÇ [Projet‚ñº]‚îÇ [Projet‚ñº]‚îÇ [Projet‚ñº]‚îÇ [Projet‚ñº]‚îÇ
‚îÇ Projet   ‚îÇ  Alpha   ‚îÇ  Beta    ‚îÇ  Alpha   ‚îÇ  Beta    ‚îÇ  Alpha   ‚îÇ
‚îÇ Beta     ‚îÇ   0.5j   ‚îÇ   0.5j   ‚îÇ          ‚îÇ   0.5j   ‚îÇ   0.5j   ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇüìÖ Journ√©e‚îÇ          ‚îÇ          ‚îÇ          ‚îÇ          ‚îÇ          ‚îÇ
‚îÇ enti√®re  ‚îÇ          ‚îÇ          ‚îÇ  Alpha   ‚îÇ          ‚îÇ          ‚îÇ
‚îÇ          ‚îÇ          ‚îÇ          ‚îÇ   1.0j   ‚îÇ          ‚îÇ          ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ TOTAL    ‚îÇ   1.0j   ‚îÇ   1.0j   ‚îÇ   1.0j   ‚îÇ   1.0j   ‚îÇ   1.0j   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

üí° Actions rapides :
[üìã Copier semaine derni√®re] [üóëÔ∏è Effacer tout] [üíæ Sauvegarder brouillon]
```

**Interactions** :
- Dropdown projet par cellule (filtr√© sur projets actifs du consultant)
- Auto-save toutes les 30s
- Validation temps r√©el (max 1j/jour)
- Badge couleur : üü¢ Valid√© | üü° Soumis | ‚ö™ Brouillon

### 7.4 Interface Mobile (PWA)

**Vue Quotidienne simplifi√©e** :

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  üìÖ Lundi 6 janvier 2025        ‚îÇ
‚îÇ                                 ‚îÇ
‚îÇ  ‚òÄÔ∏è MATIN                       ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ  ‚îÇ Projet Alpha          0.5j ‚îÇ ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ  [+ Ajouter projet matin]      ‚îÇ
‚îÇ                                 ‚îÇ
‚îÇ  üåô APR√àS-MIDI                  ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ  ‚îÇ Projet Beta           0.5j ‚îÇ ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ  [+ Ajouter projet apr√®s-midi] ‚îÇ
‚îÇ                                 ‚îÇ
‚îÇ  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ    ‚îÇ
‚îÇ  Total jour : 1.0j / 1.0j ‚úÖ   ‚îÇ
‚îÇ                                 ‚îÇ
‚îÇ  [< Hier]  [Soumettre]  [Demain >]
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**Ajout projet (bottom sheet)** :

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  üåÖ Saisir temps - MATIN        ‚îÇ
‚îÇ                                 ‚îÇ
‚îÇ  Projet :                       ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ  ‚îÇ üîç Rechercher projet...   ‚îÇ ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ                                 ‚îÇ
‚îÇ  Projets actifs :               ‚îÇ
‚îÇ  ‚òê Projet Alpha                 ‚îÇ
‚îÇ  ‚òê Projet Beta                  ‚îÇ
‚îÇ  ‚òê Projet Gamma                 ‚îÇ
‚îÇ                                 ‚îÇ
‚îÇ  [Annuler]         [Valider]    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**Gestes rapides** :
- Swipe gauche/droite : navigation jours
- Tap carte projet : √©diter/supprimer
- Long press : copier vers autre p√©riode
- Pull refresh : sync donn√©es

### 7.4.1 Impl√©mentation React + Tailwind CSS

**Design System Tailwind** :

```javascript
// tailwind.config.js - Configuration couleurs projet
export default {
  theme: {
    extend: {
      colors: {
        primary: {
          50: '#eff6ff',
          500: '#3b82f6',
          600: '#2563eb',
          700: '#1d4ed8',
        },
        status: {
          draft: '#94a3b8',      // Gris
          submitted: '#f59e0b',  // Orange
          validated: '#10b981',  // Vert
          rejected: '#ef4444',   // Rouge
        }
      },
    },
  },
}
```

**Composant TimeEntry (Saisie Demi-Journ√©e)** :

```typescript
// components/TimeEntry.tsx
import { useState } from 'react';

interface TimeEntryProps {
  date: Date;
  periode: 'matin' | 'apres_midi' | 'journee';
  projects: Project[];
  onSave: (entry: TimeEntryData) => void;
}

export function TimeEntry({ date, periode, projects, onSave }: TimeEntryProps) {
  const [selectedProject, setSelectedProject] = useState<string>('');
  const [jours, setJours] = useState<number>(0.5);

  const periodeLabels = {
    matin: '‚òÄÔ∏è Matin',
    apres_midi: 'üåô Apr√®s-midi',
    journee: 'üìÖ Journ√©e'
  };

  return (
    <div className="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
      {/* Header */}
      <div className="flex items-center justify-between mb-3">
        <span className="text-sm font-medium text-gray-700">
          {periodeLabels[periode]}
        </span>
        <span className="text-xs text-gray-500">
          {jours}j
        </span>
      </div>

      {/* S√©lecteur projet */}
      <select
        value={selectedProject}
        onChange={(e) => setSelectedProject(e.target.value)}
        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent text-sm"
      >
        <option value="">S√©lectionner un projet...</option>
        {projects.map(p => (
          <option key={p.id} value={p.id}>{p.nom}</option>
        ))}
      </select>

      {/* Boutons jours (si p√©riode != journee) */}
      {periode !== 'journee' && (
        <div className="mt-3 flex gap-2">
          <button
            onClick={() => setJours(0.5)}
            className={`flex-1 px-3 py-2 rounded-lg text-sm font-medium transition-colors ${
              jours === 0.5
                ? 'bg-primary-600 text-white'
                : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
            }`}
          >
            0.5j
          </button>
          <button
            onClick={() => setJours(1)}
            className={`flex-1 px-3 py-2 rounded-lg text-sm font-medium transition-colors ${
              jours === 1
                ? 'bg-primary-600 text-white'
                : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
            }`}
          >
            1j
          </button>
        </div>
      )}
    </div>
  );
}
```

**Composant WeeklyTimesheet (Vue Hebdomadaire)** :

```typescript
// components/WeeklyTimesheet.tsx
import { useState } from 'react';

export function WeeklyTimesheet() {
  const [weekDays, setWeekDays] = useState(generateWeekDays());

  return (
    <div className="bg-white rounded-xl shadow-lg overflow-hidden">
      {/* Header */}
      <div className="bg-gradient-to-r from-primary-600 to-primary-700 px-6 py-4">
        <div className="flex items-center justify-between">
          <div>
            <h2 className="text-xl font-semibold text-white">
              Semaine du {weekDays[0].format('DD')} au {weekDays[4].format('DD MMM YYYY')}
            </h2>
            <p className="text-primary-100 text-sm mt-1">
              Saisie temps par demi-journ√©e
            </p>
          </div>
          <button className="bg-white text-primary-700 px-4 py-2 rounded-lg font-medium hover:bg-primary-50 transition-colors">
            Soumettre
          </button>
        </div>
      </div>

      {/* Grid calendrier */}
      <div className="p-6">
        <div className="grid grid-cols-6 gap-4">
          {/* Header colonnes jours */}
          <div className="col-span-1"></div>
          {weekDays.map((day, i) => (
            <div key={i} className="text-center">
              <div className="text-xs text-gray-500 uppercase">
                {day.format('ddd')}
              </div>
              <div className="text-lg font-semibold text-gray-900 mt-1">
                {day.format('DD')}
              </div>
            </div>
          ))}

          {/* Ligne Matin */}
          <div className="flex items-center text-sm font-medium text-gray-700">
            ‚òÄÔ∏è Matin
          </div>
          {weekDays.map((day, i) => (
            <TimeEntryCell key={`matin-${i}`} date={day} periode="matin" />
          ))}

          {/* Ligne Apr√®s-midi */}
          <div className="flex items-center text-sm font-medium text-gray-700">
            üåô AM
          </div>
          {weekDays.map((day, i) => (
            <TimeEntryCell key={`am-${i}`} date={day} periode="apres_midi" />
          ))}

          {/* Ligne Journ√©e */}
          <div className="flex items-center text-sm font-medium text-gray-700">
            üìÖ Jour
          </div>
          {weekDays.map((day, i) => (
            <TimeEntryCell key={`jour-${i}`} date={day} periode="journee" />
          ))}

          {/* Total */}
          <div className="col-span-1 flex items-center text-sm font-semibold text-gray-900">
            TOTAL
          </div>
          {weekDays.map((day, i) => (
            <div key={`total-${i}`} className="text-center">
              <span className="inline-flex items-center justify-center w-12 h-12 rounded-full bg-green-100 text-green-700 font-semibold">
                1.0j
              </span>
            </div>
          ))}
        </div>

        {/* Actions rapides */}
        <div className="flex gap-3 mt-6 pt-6 border-t border-gray-200">
          <button className="flex items-center gap-2 px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors">
            üìã Copier semaine derni√®re
          </button>
          <button className="flex items-center gap-2 px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors">
            üóëÔ∏è Effacer tout
          </button>
          <button className="flex items-center gap-2 px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors">
            üíæ Sauvegarder brouillon
          </button>
        </div>
      </div>
    </div>
  );
}
```

**Composant Badge Statut** :

```typescript
// components/StatusBadge.tsx
type Status = 'draft' | 'submitted' | 'validated' | 'rejected';

interface StatusBadgeProps {
  status: Status;
}

const statusConfig = {
  draft: {
    label: 'Brouillon',
    icon: '‚ö™',
    classes: 'bg-gray-100 text-gray-700 border-gray-300'
  },
  submitted: {
    label: 'Soumis',
    icon: 'üü°',
    classes: 'bg-yellow-100 text-yellow-700 border-yellow-300'
  },
  validated: {
    label: 'Valid√©',
    icon: 'üü¢',
    classes: 'bg-green-100 text-green-700 border-green-300'
  },
  rejected: {
    label: 'Rejet√©',
    icon: 'üî¥',
    classes: 'bg-red-100 text-red-700 border-red-300'
  }
};

export function StatusBadge({ status }: StatusBadgeProps) {
  const config = statusConfig[status];
  
  return (
    <span className={`inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-xs font-medium border ${config.classes}`}>
      <span>{config.icon}</span>
      {config.label}
    </span>
  );
}
```

**Composant Dashboard Cards (Project Owner)** :

```typescript
// components/DashboardCard.tsx
interface DashboardCardProps {
  title: string;
  value: string | number;
  subtitle?: string;
  trend?: 'up' | 'down' | 'neutral';
  icon?: string;
}

export function DashboardCard({ title, value, subtitle, trend, icon }: DashboardCardProps) {
  const trendColors = {
    up: 'text-green-600',
    down: 'text-red-600',
    neutral: 'text-gray-600'
  };

  return (
    <div className="bg-white rounded-xl shadow-sm border border-gray-200 p-6 hover:shadow-md transition-shadow">
      <div className="flex items-start justify-between">
        <div className="flex-1">
          <p className="text-sm text-gray-600 font-medium">{title}</p>
          <p className="text-3xl font-bold text-gray-900 mt-2">{value}</p>
          {subtitle && (
            <p className={`text-sm mt-2 ${trend ? trendColors[trend] : 'text-gray-500'}`}>
              {subtitle}
            </p>
          )}
        </div>
        {icon && (
          <div className="text-4xl opacity-20">
            {icon}
          </div>
        )}
      </div>
    </div>
  );
}

// Utilisation
<div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
  <DashboardCard
    title="Timesheets en attente"
    value="12"
    subtitle="√Ä valider cette semaine"
    icon="‚è≥"
  />
  <DashboardCard
    title="Budget consomm√©"
    value="68%"
    subtitle="+5% vs mois dernier"
    trend="up"
    icon="üí∞"
  />
  <DashboardCard
    title="Jours produits"
    value="142j"
    subtitle="Sur 210j vendus"
    icon="üìä"
  />
  <DashboardCard
    title="Marge projet"
    value="42.3%"
    subtitle="Objectif: 40%"
    trend="up"
    icon="üìà"
  />
</div>
```

**Composant Chat Conversationnel** :

```typescript
// components/Chat.tsx
import { useState, useRef, useEffect } from 'react';

export function Chat() {
  const [messages, setMessages] = useState<Message[]>([]);
  const [input, setInput] = useState('');
  const [isLoading, setIsLoading] = useState(false);
  const messagesEndRef = useRef<HTMLDivElement>(null);

  const quickActions = [
    { label: '‚ö° Saisir 1 jour aujourd\'hui', action: 'quick_add_day' },
    { label: '‚úÖ Valider tous', action: 'validate_all' },
    { label: 'üìä Mon utilisation', action: 'my_utilization' },
  ];

  return (
    <div className="fixed bottom-4 right-4 w-96 h-[600px] bg-white rounded-2xl shadow-2xl flex flex-col overflow-hidden border border-gray-200">
      {/* Header */}
      <div className="bg-gradient-to-r from-primary-600 to-primary-700 px-4 py-3 flex items-center justify-between">
        <div className="flex items-center gap-2">
          <div className="w-3 h-3 bg-green-400 rounded-full animate-pulse"></div>
          <h3 className="text-white font-semibold">üí¨ Assistant Staffing</h3>
        </div>
        <button className="text-white hover:bg-white/20 rounded-lg p-1.5 transition-colors">
          ‚úï
        </button>
      </div>

      {/* Messages */}
      <div className="flex-1 overflow-y-auto p-4 space-y-4">
        {messages.map((msg, i) => (
          <div key={i} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
            <div className={`max-w-[80%] rounded-2xl px-4 py-2 ${
              msg.role === 'user'
                ? 'bg-primary-600 text-white'
                : 'bg-gray-100 text-gray-900'
            }`}>
              <p className="text-sm">{msg.content}</p>
            </div>
          </div>
        ))}
        {isLoading && (
          <div className="flex justify-start">
            <div className="bg-gray-100 rounded-2xl px-4 py-2">
              <div className="flex gap-1">
                <div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></div>
                <div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce delay-100"></div>
                <div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce delay-200"></div>
              </div>
            </div>
          </div>
        )}
        <div ref={messagesEndRef} />
      </div>

      {/* Quick Actions */}
      <div className="px-4 py-2 border-t border-gray-200 bg-gray-50">
        <div className="flex gap-2 overflow-x-auto pb-2">
          {quickActions.map((action, i) => (
            <button
              key={i}
              className="flex-shrink-0 px-3 py-1.5 bg-white border border-gray-300 rounded-full text-xs font-medium text-gray-700 hover:bg-gray-100 transition-colors"
            >
              {action.label}
            </button>
          ))}
        </div>
      </div>

      {/* Input */}
      <div className="p-4 border-t border-gray-200">
        <div className="flex gap-2">
          <input
            type="text"
            value={input}
            onChange={(e) => setInput(e.target.value)}
            placeholder="Posez votre question..."
            className="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 text-sm"
          />
          <button className="bg-primary-600 text-white px-4 py-2 rounded-lg hover:bg-primary-700 transition-colors">
            ‚û§
          </button>
        </div>
      </div>
    </div>
  );
}
```

**Composant Mobile PWA (Vue Quotidienne)** :

```typescript
// components/mobile/DailyView.tsx
export function DailyView() {
  const [date, setDate] = useState(new Date());
  const [entries, setEntries] = useState<TimeEntry[]>([]);

  return (
    <div className="min-h-screen bg-gray-50 pb-20">
      {/* Header */}
      <div className="bg-white border-b border-gray-200 sticky top-0 z-10">
        <div className="px-4 py-4">
          <div className="flex items-center justify-between">
            <button className="text-gray-600">
              ‚Üê Hier
            </button>
            <h2 className="font-semibold text-gray-900">
              üìÖ {date.toLocaleDateString('fr-FR', { 
                weekday: 'long', 
                day: 'numeric', 
                month: 'long' 
              })}
            </h2>
            <button className="text-gray-600">
              Demain ‚Üí
            </button>
          </div>
        </div>
      </div>

      {/* Content */}
      <div className="p-4 space-y-4">
        {/* Matin */}
        <div>
          <h3 className="text-sm font-medium text-gray-700 mb-2">
            ‚òÄÔ∏è MATIN
          </h3>
          <div className="bg-white rounded-lg p-4 shadow-sm border border-gray-200">
            <div className="flex items-center justify-between">
              <span className="text-sm text-gray-900">Projet Alpha</span>
              <span className="text-xs font-medium text-gray-500">0.5j</span>
            </div>
          </div>
          <button className="w-full mt-2 py-2 text-sm text-primary-600 font-medium">
            + Ajouter projet matin
          </button>
        </div>

        {/* Apr√®s-midi */}
        <div>
          <h3 className="text-sm font-medium text-gray-700 mb-2">
            üåô APR√àS-MIDI
          </h3>
          <div className="bg-white rounded-lg p-4 shadow-sm border border-gray-200">
            <div className="flex items-center justify-between">
              <span className="text-sm text-gray-900">Projet Beta</span>
              <span className="text-xs font-medium text-gray-500">0.5j</span>
            </div>
          </div>
          <button className="w-full mt-2 py-2 text-sm text-primary-600 font-medium">
            + Ajouter projet apr√®s-midi
          </button>
        </div>

        {/* Total */}
        <div className="bg-gradient-to-r from-green-50 to-emerald-50 rounded-lg p-4 border-2 border-green-200">
          <div className="flex items-center justify-between">
            <span className="text-sm font-medium text-green-900">Total jour</span>
            <span className="text-lg font-bold text-green-700">1.0j / 1.0j ‚úÖ</span>
          </div>
        </div>
      </div>

      {/* Bottom Actions */}
      <div className="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 p-4">
        <div className="flex gap-3">
          <button className="flex-1 bg-gray-100 text-gray-700 py-3 rounded-lg font-medium hover:bg-gray-200 transition-colors">
            Annuler
          </button>
          <button className="flex-1 bg-primary-600 text-white py-3 rounded-lg font-medium hover:bg-primary-700 transition-colors">
            Soumettre
          </button>
        </div>
      </div>
    </div>
  );
}
```

**Utilitaires Tailwind Personnalis√©s** :

```css
/* src/index.css */
@tailwind base;
@tailwind components;
@tailwind utilities;

@layer components {
  /* Boutons */
  .btn-primary {
    @apply bg-primary-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-primary-700 active:bg-primary-800 transition-colors disabled:opacity-50 disabled:cursor-not-allowed;
  }
  
  .btn-secondary {
    @apply bg-gray-100 text-gray-700 px-4 py-2 rounded-lg font-medium hover:bg-gray-200 active:bg-gray-300 transition-colors;
  }

  .btn-danger {
    @apply bg-red-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-red-700 active:bg-red-800 transition-colors;
  }

  /* Cards */
  .card {
    @apply bg-white rounded-lg shadow-sm border border-gray-200 p-6 hover:shadow-md transition-shadow;
  }

  .card-compact {
    @apply bg-white rounded-lg shadow-sm border border-gray-200 p-4;
  }

  /* Inputs */
  .input {
    @apply w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent disabled:bg-gray-100 disabled:cursor-not-allowed;
  }

  .input-error {
    @apply border-red-500 focus:ring-red-500;
  }

  /* Select */
  .select {
    @apply w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent bg-white cursor-pointer;
  }

  /* Badges */
  .badge {
    @apply inline-flex items-center gap-1.5 px-2.5 py-0.5 rounded-full text-xs font-medium;
  }

  /* Loading spinner */
  .spinner {
    @apply animate-spin rounded-full border-2 border-gray-300 border-t-primary-600;
  }
}

/* Animations custom */
@layer utilities {
  .animate-slide-in {
    animation: slideIn 0.3s ease-out;
  }

  @keyframes slideIn {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
}
```

### 7.5 Interface Conversationnelle (Chat)

**Exemples de commandes** :

```
üí¨ User: "Saisi 1 jour projet Alpha aujourd'hui"
ü§ñ Bot: J'ai saisi 1 jour complet sur Projet Alpha pour aujourd'hui (6 janvier).
       Total semaine : 3 jours.

üí¨ User: "Matin projet Beta, apr√®s-midi projet Gamma"
ü§ñ Bot: Saisie effectu√©e :
       ‚Ä¢ Matin : Projet Beta (0.5j)
       ‚Ä¢ Apr√®s-midi : Projet Gamma (0.5j)
       Total : 1 jour

üí¨ User: "Combien j'ai fait cette semaine ?"
ü§ñ Bot: Semaine du 6 au 10 janvier :
       ‚Ä¢ Projet Alpha : 3.5 jours
       ‚Ä¢ Projet Beta : 1 jour
       ‚Ä¢ Projet Gamma : 0.5 jour
       ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
       Total : 5 jours / 5 jours ‚úÖ

üí¨ User: "Copie la semaine derni√®re"
ü§ñ Bot: J'ai copi√© les 5 jours de la semaine du 30 d√©c au 3 jan.
       Voulez-vous ajuster quelque chose ?

üí¨ User: "Journ√©e compl√®te projet Alpha mercredi"
ü§ñ Bot: Saisie 1 jour sur Projet Alpha pour mercredi 8 janvier.
```

**Variations naturelles support√©es** :
- "1j Alpha", "1 jour Alpha", "journ√©e Alpha"
- "matin Beta", "matin√©e Beta", "AM Beta"
- "aprem Gamma", "apr√®s-midi Gamma", "PM Gamma"
- "demie journ√©e Alpha", "demi-journ√©e Alpha", "0.5j Alpha"

### 7.6 Validation automatique

**R√®gles impl√©ment√©es** :

```typescript
// Validation saisie
function validateTimeEntry(date: string, entries: TimeEntry[]): ValidationResult {
  // R√®gle 1 : Max 2 saisies par jour
  if (entries.length > 2) {
    return { valid: false, error: 'Maximum 2 saisies par jour (matin + apr√®s-midi)' };
  }
  
  // R√®gle 2 : Pas de doublon p√©riode
  const periodes = entries.map(e => e.periode);
  if (new Set(periodes).size !== periodes.length) {
    return { valid: false, error: 'P√©riode d√©j√† saisie pour ce jour' };
  }
  
  // R√®gle 3 : Max 1 jour total
  const totalJours = entries.reduce((sum, e) => sum + e.jours, 0);
  if (totalJours > 1.0) {
    return { valid: false, error: `Total ${totalJours}j d√©passe 1 jour maximum` };
  }
  
  // R√®gle 4 : Si "journee", pas d'autre saisie
  const hasJourneeComplete = entries.some(e => e.periode === 'journee');
  if (hasJourneeComplete && entries.length > 1) {
    return { valid: false, error: 'Journ√©e compl√®te incompatible avec matin/apr√®s-midi' };
  }
  
  return { valid: true };
}
```

### 7.7 Rapports et agr√©gations

**Tous les calculs en jours** :

```typescript
// Exemple rapport mensuel
interface MonthlyReport {
  consultant_id: string;
  mois: string;
  jours_travailles: number;      // Ex: 19.5 jours
  jours_ouvrables: number;        // Ex: 21 jours
  taux_utilisation: number;       // Ex: 92.9%
  
  par_projet: {
    project_id: string;
    nom_projet: string;
    jours: number;                // Ex: 12.5 jours
    ca_genere: number;            // jours √ó TJ
  }[];
}

// Calcul marge projet
const marge = (jours_produits √ó TJ) - (jours_produits √ó CJN);
const marge_pct = marge / (jours_produits √ó TJ) √ó 100;
```

### 7.8 Avantages vs saisie horaire

| Aspect | Saisie Horaire | Saisie Demi-Journ√©e |
|--------|----------------|---------------------|
| **Rapidit√©** | 3-5 min/semaine | **30 sec/semaine** ‚úÖ |
| **Mobile** | Fastidieux | **Optimal** ‚úÖ |
| **Pr√©cision** | Fausse pr√©cision | **R√©aliste** ‚úÖ |
| **D√©bats** | "Vraiment 7h52 ?" | Aucun ‚úÖ |
| **Calculs** | Conversion h‚Üíj | **Direct** ‚úÖ |
| **Validation** | R√®gles complexes | **2 r√®gles simples** ‚úÖ |

---

## 8. API REST (Hono + Workers)

### 8.1 Architecture API

```typescript
// api/index.ts
import { Hono } from 'hono';
import { jwt } from 'hono/jwt';
import { cors } from 'hono/cors';

const app = new Hono();

// Middlewares globaux
app.use('*', cors());
app.use('/api/*', jwt({ secret: env.JWT_SECRET }));
app.use('/api/*', rbacMiddleware);  // Contr√¥le acc√®s par r√¥le

// Routes principales
app.route('/api/auth', authRoutes);
app.route('/api/consultants', consultantRoutes);
app.route('/api/projects', projectRoutes);
app.route('/api/interventions', interventionRoutes);
app.route('/api/timesheets', timesheetRoutes);
app.route('/api/reports', reportRoutes);
app.route('/api/chat', chatRoutes);        // Interface conversationnelle
app.route('/mcp', mcpRoutes);              // Serveur MCP

export default app;
```

### 8.2 Exemples endpoints avec contr√¥le CJR/CJN

```typescript
// GET /api/consultants/:id
app.get('/api/consultants/:id', async (c) => {
  const consultantId = c.req.param('id');
  const user = c.get('jwtPayload');
  
  const consultant = await db.prepare(`
    SELECT 
      consultant_id, nom, prenom, profil_seniority,
      ${user.role === 'directeur' ? 'cjn, cjr' : 'cjn'} as cout
    FROM consultants 
    WHERE consultant_id = ?
  `).bind(consultantId).first();
  
  // Audit si acc√®s CJR
  if (user.role === 'directeur') {
    await auditLog(user.user_id, 'VIEW_CJR', consultantId);
  }
  
  return c.json(consultant);
});

// GET /api/projects/:id/margin
app.get('/api/projects/:id/margin', async (c) => {
  const projectId = c.req.param('id');
  const user = c.get('jwtPayload');
  const useRealCost = c.req.query('real') === 'true';
  
  // V√©rification acc√®s CJR
  if (useRealCost && user.role !== 'directeur') {
    return c.json({ error: 'Unauthorized: CJR access requires Directeur role' }, 403);
  }
  
  const margin = await db.prepare(`
    SELECT 
      project_id, code_projet, nom_projet,
      ca_realise,
      ${useRealCost ? 'cout_cjr as cout, marge_cjr as marge, marge_pct_cjr as marge_pct' 
                    : 'cout_cjn as cout, marge_cjn as marge, marge_pct_cjn as marge_pct'}
    FROM v_project_margins
    WHERE project_id = ?
  `).bind(projectId).first();
  
  if (useRealCost) {
    await auditLog(user.user_id, 'VIEW_PROJECT_MARGIN_CJR', projectId);
  }
  
  return c.json(margin);
});

// POST /api/timesheets/validate-bulk
app.post('/api/timesheets/validate-bulk', async (c) => {
  const { time_entry_ids } = await c.req.json();
  const user = c.get('jwtPayload');
  
  // V√©rification r√¥le
  if (!['project_owner', 'administrator', 'directeur'].includes(user.role)) {
    return c.json({ error: 'Unauthorized' }, 403);
  }
  
  // Validation en masse
  const results = await Promise.all(
    time_entry_ids.map(id => validateTimeEntry(id, user.user_id))
  );
  
  return c.json({ validated: results.length });
});
```

### 8.3 Documentation API (OpenAPI)

Auto-g√©n√©r√©e via Hono + Zod :

```typescript
import { OpenAPIHono } from '@hono/zod-openapi';
import { z } from 'zod';

const app = new OpenAPIHono();

// Sch√©ma validation
const TimesheetSchema = z.object({
  project_id: z.string().uuid(),
  periode: z.enum(['matin', 'apres_midi', 'journee']),
  jours: z.number().refine(val => val === 0.5 || val === 1.0, {
    message: 'Jours doit √™tre 0.5 ou 1.0'
  }),
  date: z.string().regex(/^\d{4}-\d{2}-\d{2}$/),
});

// Route avec validation automatique
app.openapi(
  {
    method: 'post',
    path: '/api/timesheets',
    request: {
      body: {
        content: {
          'application/json': {
            schema: TimesheetSchema,
          },
        },
      },
    },
    responses: {
      201: {
        description: 'Timesheet created',
      },
    },
  },
  async (c) => {
    const data = c.req.valid('json');
    // ... cr√©ation
  }
);

// G√©n√©ration doc auto
app.doc('/openapi.json', {
  openapi: '3.1.0',
  info: { title: 'Staffing API', version: '1.0.0' },
});
```

Accessible sur : `https://your-domain.workers.dev/openapi.json`

---

## 9. ROADMAP 60 JOURS

### Sprint 1 : Infrastructure & Auth (Jours 1-10)

**Objectif** : Base technique fonctionnelle

- [ ] Setup Cloudflare (Workers, D1, Pages, R2)
- [ ] Sch√©ma DB D1 (8 tables + vues)
- [ ] API Hono avec JWT auth
- [ ] RBAC middleware (4 r√¥les)
- [ ] Frontend React PWA (shell)
- [ ] CI/CD GitHub Actions ‚Üí Cloudflare

**Livrable** : Login fonctionnel + DB initialis√©e

### Sprint 2 : Core Features (Jours 11-25)

**Objectif** : Saisie temps + validation

- [ ] CRUD Consultants (avec CJN/CJR + audit)
- [ ] CRUD Projets
- [ ] Gestion Interventions (allocations)
- [ ] Saisie timesheet web + mobile (PWA)
- [ ] Workflow validation simple (1 niveau)
- [ ] Dashboard consultant (mes projets, mon temps)
- [ ] Dashboard Project Owner (validation, budget)

**Livrable** : Cycle complet saisie ‚Üí validation

### Sprint 3 : Dashboards & Reports (Jours 26-40)

**Objectif** : Visibilit√© et pilotage

- [ ] Dashboard Administrator (capacit√©, conflits)
- [ ] **Dashboard Directeur** (marges CJR, P&L r√©el)
- [ ] Rapports utilisation (CJN)
- [ ] Rapports marges projets (CJN pour Owners, CJR pour Directeur)
- [ ] D√©tection conflits allocation
- [ ] Exports Excel/PDF
- [ ] Notifications email (Queues)

**Livrable** : Pilotage complet disponible

### Sprint 4 : Chat & MCP (Jours 41-55)

**Objectif** : Interface conversationnelle

- [ ] Google Gemini API int√©gration (configuration Cloudflare Secrets)
- [ ] Chat UI (composant React)
- [ ] D√©tection intentions (NLU simple)
- [ ] Actions chat (10 principales)
- [ ] Serveur MCP (5 outils core)
- [ ] Historique conversations (D1)
- [ ] Quick actions par r√¥le

**Livrable** : Chat op√©rationnel pour 80% actions courantes

### Sprint 5 : Polish & Deploy (Jours 56-60)

**Objectif** : Production-ready

- [ ] Tests E2E (Playwright)
- [ ] Optimisations performance
- [ ] Documentation utilisateur
- [ ] Formation √©quipe pilote
- [ ] Monitoring (Cloudflare Analytics)
- [ ] Migration donn√©es legacy
- [ ] Go-live

**Livrable** : Application en production

---

## 10. FONCTIONNALIT√âS PAR PERSONA (PRIORIS√âES)

### 10.1 Consultant (Essentiel seulement)

‚úÖ **P0 (Sprint 2)** :
- Saisir temps par **demi-journ√©e** (matin/apr√®s-midi/journ√©e) web + mobile PWA
- Voir ses projets actifs
- Soumettre timesheet
- Voir statut validation

‚úÖ **P1 (Sprint 4)** :
- Chat : "Saisi 1 jour projet X", "Matin Alpha apr√®s-midi Beta", "Combien de jours cette semaine ?"
- Copier semaine derni√®re
- Notifications validation

‚ùå **P2 (Post-MVP)** :
- Demande cong√©s
- Export PDF

### 9.2 Project Owner

‚úÖ **P0 (Sprint 2)** :
- Valider/rejeter timesheets
- Voir budget projet (bas√© CJN)
- Liste consultants assign√©s

‚úÖ **P1 (Sprint 3)** :
- Dashboard validation (file attente)
- Validation en masse (bulk)
- Alertes budget >90%
- Marges projet (CJN)

‚úÖ **P2 (Sprint 4)** :
- Chat : "Valider tout", "Budget projet X ?"
- Export Excel heures valid√©es

### 9.3 Administrator

‚úÖ **P0 (Sprint 2)** :
- Cr√©er projets
- Affecter consultants
- G√©rer allocations

‚úÖ **P1 (Sprint 3)** :
- Dashboard capacit√© (heatmap)
- D√©tection conflits allocation
- Vue utilisation globale (CJN)
- Rapports exports

‚úÖ **P2 (Sprint 4)** :
- Chat : "Qui disponible en React ?", "Cr√©er projet X"
- Forecast capacit√© 3 mois

### 9.4 Directeur (NOUVEAU)

‚úÖ **P0 (Sprint 3)** :
- Toutes fonctions Administrator
- Dashboard financier (CJR + CJN)
- Marges r√©elles par projet (TJ - CJR)
- Acc√®s audit log CJR

‚úÖ **P1 (Sprint 3)** :
- Analyse √©carts CJR vs CJN
- P&L consolid√© r√©el
- Top consultants rentabilit√© r√©elle
- Exports financiers

‚úÖ **P2 (Sprint 4)** :
- Chat : "Marge r√©elle projet X ?", "CJR vs CJN √©carts"
- Alertes marges <20% (CJR)

---

## 11. CRIT√àRES DE SUCC√àS

### 10.1 Technique

‚úÖ H√©bergement Cloudflare : **< 15‚Ç¨/mois**
‚úÖ Performance API : **< 200ms p95**
‚úÖ PWA offline : **cache 7 jours**
‚úÖ Uptime : **> 99%** (Cloudflare SLA)
‚úÖ S√©curit√© : **Audit CJR 100% trac√©**

### 10.2 Adoption (3 mois)

‚úÖ **90%** consultants saisissent temps hebdo
‚úÖ **< 24h** d√©lai validation moyen
‚úÖ **> 4/5** satisfaction utilisateurs (NPS)
‚úÖ **60%** actions via chat (vs formulaires)

### 10.3 Business (6 mois)

‚úÖ **+3%** taux utilisation (70% ‚Üí 73%)
‚úÖ **Visibilit√© temps r√©el** sur budgets projets
‚úÖ **100%** marges projets calcul√©es (CJN + CJR)
‚úÖ **-50%** temps admin staffing

### 10.4 ROI

**Investissement** :
- D√©veloppement : 60j √ó 600‚Ç¨/j = **36 000‚Ç¨**
- H√©bergement 1 an : 12 √ó 15‚Ç¨ = **180‚Ç¨**
- Formation : **2 000‚Ç¨**
- **TOTAL** : **38 200‚Ç¨**

**Gains Ann√©e 1** (ESN 50 consultants) :
- +3% utilisation √ó 50 consultants √ó 210j √ó 150‚Ç¨ marge/j = **+47 250‚Ç¨**
- -50% temps admin staffing (0.5 ETP) = **+25 000‚Ç¨**
- Meilleure visibilit√© marges (r√©duction pertes 2%) = **+15 000‚Ç¨**
- **TOTAL GAINS** : **87 250‚Ç¨**

**ROI Ann√©e 1** : (87 250 - 180) / 38 200 = **228%** üéØ
**Payback** : **5.3 mois**

---

## 12. DIFF√âRENCES vs SPEC V1

| Aspect | Spec V1 (365K‚Ç¨) | Spec V2 Optimis√©e (38K‚Ç¨) |
|--------|-----------------|---------------------------|
| **Budget dev** | 310K‚Ç¨ (√©quipe) | 36K‚Ç¨ (1 dev √ó 60j) |
| **H√©bergement/an** | 6-24K‚Ç¨ (AWS/Azure) | 180‚Ç¨ (Cloudflare) |
| **D√©lai** | 12 mois | 3 mois |
| **Architecture** | Monolithe ‚Üí Microservices | Serverless Cloudflare |
| **DB** | PostgreSQL RDS | D1 SQLite |
| **Frontend** | React + Ant Design | React PWA (l√©ger) |
| **Personas** | 3 | **4 (+ Directeur)** |
| **Co√ªts** | CJM unique | **CJR + CJN** (double) |
| **Interface** | Formulaires | **Chat conversationnel 80%** |
| **Int√©grations** | REST API | **REST + MCP** |
| **Scope** | 30 user stories | 15 user stories (core) |
| **Rapports** | 12 | 6 essentiels |
| **ML/AI** | Phase 4 (M10-12) | **Google Gemini API (Sprint 4)** |
| **ROI** | 57% | **228%** |

---

## 13. RISQUES & MITIGATIONS

| Risque | Mitigation |
|--------|------------|
| **Limitations D1** (SQLite) | Optimisation requ√™tes, index strat√©giques, cache KV |
| **Gemini API qualit√©** | Fallback formulaires, fine-tuning prompts, hybrid UI, validation c√¥t√© serveur |
| **Gemini API quotas** | Free tier 60 req/min suffisant, monitoring usage, fallback gracieux |
| **S√©curit√© cl√© API** | Stockage dans Cloudflare Secrets (chiffr√©), rotation r√©guli√®re, monitoring |
| **60j trop court** | Scope strict P0/P1, r√©utilisation composants, pas de sur-engineering |
| **Adoption chat** | Interface dual (chat + classique), formation, quick actions |
| **Confidentialit√© CJR** | RBAC strict, audit 100%, MFA Directeur, session timeout court |
| **Migration donn√©es** | Scripts validation, import progressif, double-run 2 semaines |

---

## 14. PROCHAINES √âTAPES

### Semaine 1 : Setup
- [ ] Cr√©er compte Cloudflare
- [ ] Setup repos GitHub
- [ ] Initialiser Workers + D1 + Pages
- [ ] Configurer domaine + SSL

### Semaine 2 : Sprint 1
- [ ] Sch√©ma DB complet
- [ ] Auth JWT + RBAC
- [ ] API shell Hono
- [ ] React PWA shell

### Semaine 3-6 : Sprint 2 (Core)
- [ ] Configurer Cloudflare Secrets (GEMINI_API_KEY, JWT_SECRET)
- [ ] Features timesheets
- [ ] Validation workflow
- [ ] Dashboards Consultant/Owner

### Semaine 7-9 : Sprint 3 (Directeur)
- [ ] Dashboard Directeur
- [ ] CJR/CJN reports
- [ ] Conflits allocations

### Semaine 10-11 : Sprint 4 (Chat)
- [ ] Gemini API int√©gration (utilisation de GEMINI_API_KEY depuis Secrets)
- [ ] Chat UI
- [ ] MCP server

### Semaine 12 : Sprint 5 (Deploy)
- [ ] Tests E2E
- [ ] Migration donn√©es
- [ ] Formation
- [ ] Go-live

---

## 15. CONCLUSION

Cette version optimis√©e offre :

‚úÖ **Budget 10√ó inf√©rieur** (38K‚Ç¨ vs 365K‚Ç¨)
‚úÖ **H√©bergement 100√ó moins cher** (15‚Ç¨ vs 2000‚Ç¨/mois)
‚úÖ **D√©lai 4√ó plus court** (3 mois vs 12 mois)
‚úÖ **ROI 4√ó sup√©rieur** (228% vs 57%)
‚úÖ **Technologies modernes** (Serverless, Gemini API via Cloudflare Secrets, MCP)
‚úÖ **Fonctionnalit√©s cl√©s** : CJR/CJN, Directeur, Chat, MCP

**Compromis assum√©s** :
- Moins de rapports (6 vs 12)
- Features post-MVP diff√©r√©es (cong√©s, multi-validation)
- Pas de microservices (mais architecture √©volutive)

**Facteurs de succ√®s** :
1. Scope P0/P1 strictement respect√©
2. Cloudflare = 95% √©conomie + simplicit√©
3. Chat = adoption facilit√©e
4. MCP = int√©gration moderne
5. CJR/CJN = confidentialit√© + pilotage

---

**Document pr√©par√© pour** : Projet ESN 50 consultants
**Budget** : 38 200‚Ç¨ (vs 365 000‚Ç¨ v1)
**D√©lai** : 60 jours-personne
**H√©bergement** : 15‚Ç¨/mois (vs 2000‚Ç¨/mois)
**ROI Ann√©e 1** : 228%
**Version** : 2.0 - Optimis√©e Cloudflare + Chat + MCP
**Date** : Janvier 2025
