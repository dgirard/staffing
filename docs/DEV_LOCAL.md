# üíª Guide D√©veloppement Local - Staffing ESN

> **Objectif** : D√©marrer l'environnement de d√©veloppement en 1 commande et tester localement sans d√©ployer

---

## üöÄ Quick Start (30 secondes)

### Option 1 : Tout automatique (recommand√©)

```bash
# Cloner le repo
git clone <repo-url>
cd staff

# Bootstrap (installe tout)
npm run bootstrap

# D√©marrer l'environnement complet (API + Frontend + DB)
npm run dev
```

‚úÖ **C'est tout !**
- API disponible sur http://localhost:8787
- Frontend disponible sur http://localhost:5173
- DB D1 locale cr√©√©e automatiquement

### Option 2 : Avec donn√©es de test

```bash
npm run dev:seed
```

D√©marre tout + charge des donn√©es de test (utilisateurs, projets, consultants).

---

## üìã Pr√©requis

### Logiciels requis

```bash
# Node.js 20+
node --version  # v20.x.x

# npm 10+
npm --version   # 10.x.x

# Git
git --version
```

### Comptes requis

- ‚úÖ Compte Cloudflare (pour d√©ploiements)
- ‚úÖ Cl√© API Google Gemini (pour le chat)

---

## üõ†Ô∏è Installation D√©taill√©e

### √âtape 1 : Cloner et installer

```bash
git clone <repo-url>
cd staff

# Installer les d√©pendances (API + Frontend)
npm run bootstrap
```

Ce script ex√©cute :
```bash
cd api && npm install
cd frontend && npm install
```

### √âtape 2 : Configuration des secrets locaux

```bash
# Cr√©er fichier de secrets locaux
cp api/.dev.vars.example api/.dev.vars

# √âditer le fichier
nano api/.dev.vars
```

**api/.dev.vars** :
```env
JWT_SECRET=dev-local-secret-32-chars-minimum-for-jwt
GEMINI_API_KEY=your-gemini-api-key-here
```

‚ö†Ô∏è **Important** : Ne jamais commiter `.dev.vars` (d√©j√† dans `.gitignore`)

### √âtape 3 : Cr√©er la base de donn√©es locale

```bash
cd api

# Cr√©er la DB D1 locale
npx wrangler d1 create staffing-db --local

# Appliquer les migrations
npx wrangler d1 execute staffing-db --local --file=migrations/001_initial.sql

# (Optionnel) Charger les seed data
npx wrangler d1 execute staffing-db --local --file=migrations/002_seed.sql
```

---

## üíª D√©veloppement Quotidien

### D√©marrage

```bash
# D√©marrer tout (API + Frontend + DB)
npm run dev
```

Ou manuellement dans 2 terminaux :

**Terminal 1 - API** :
```bash
cd api
npx wrangler dev --local --port 8787
```

**Terminal 2 - Frontend** :
```bash
cd frontend
npm run dev
```

### URLs locales

| Service | URL | Description |
|---------|-----|-------------|
| **Frontend** | http://localhost:5173 | Interface React |
| **API** | http://localhost:8787 | API Hono |
| **API Health** | http://localhost:8787/health | Health check |
| **API OpenAPI** | http://localhost:8787/openapi.json | Documentation API |

### Arr√™ter

```bash
# Ctrl+C dans chaque terminal
# ou
npm run dev:stop  # Si script de gestion des processus
```

---

## üß™ Tests en Local

### Tests unitaires

```bash
# API
cd api && npm test

# Frontend
cd frontend && npm test

# Tout
npm run test:all
```

### Tests avec watch mode

```bash
# API - Re-run automatique sur changement
cd api && npm run test:watch

# Frontend
cd frontend && npm run test:watch
```

### Tests E2E

```bash
# D√©marrer l'environnement d'abord
npm run dev

# Dans un autre terminal, lancer les tests E2E
cd frontend && npm run test:e2e
```

### Coverage

```bash
# Voir le coverage
npm run test:coverage

# Ouvrir le rapport HTML
open api/coverage/index.html
open frontend/coverage/index.html
```

---

## üóÑÔ∏è Base de Donn√©es Locale

### Requ√™tes SQL

```bash
cd api

# Ex√©cuter une requ√™te
npx wrangler d1 execute staffing-db --local \
  --command="SELECT * FROM users"

# Ex√©cuter un fichier SQL
npx wrangler d1 execute staffing-db --local \
  --file=migrations/custom-query.sql
```

### Voir les donn√©es

```bash
# Lister les tables
npx wrangler d1 execute staffing-db --local \
  --command="SELECT name FROM sqlite_master WHERE type='table'"

# Compter les enregistrements
npx wrangler d1 execute staffing-db --local \
  --command="SELECT
    (SELECT COUNT(*) FROM users) as users,
    (SELECT COUNT(*) FROM consultants) as consultants,
    (SELECT COUNT(*) FROM projects) as projects"
```

### Reset DB

```bash
cd api

# Supprimer la DB locale
rm -rf .wrangler/state

# Recr√©er
npx wrangler d1 execute staffing-db --local --file=migrations/001_initial.sql
npx wrangler d1 execute staffing-db --local --file=migrations/002_seed.sql
```

---

## üé≠ Seed Data - Donn√©es de Test

### Utilisateurs de test

| Email | Password | Role | Description |
|-------|----------|------|-------------|
| consultant@test.com | Test1234! | consultant | Consultant basique |
| owner@test.com | Test1234! | project_owner | Project Owner |
| admin@test.com | Test1234! | administrator | Administrateur |
| directeur@test.com | Admin1234! | directeur | Directeur (acc√®s CJR) |

### Projets de test

- **Alpha** - Projet r√©gie client Acme Corp
- **Beta** - Projet forfait client TechStart
- **Gamma** - Projet interne

### Consultants de test

- **Jean Dupont** - Senior Developer (CJN: 450‚Ç¨, CJR: 380‚Ç¨)
- **Marie Martin** - Consultant (CJN: 400‚Ç¨, CJR: 340‚Ç¨)
- **Pierre Durand** - Junior (CJN: 300‚Ç¨, CJR: 280‚Ç¨)

### Charger les seed data

```bash
cd api
npx wrangler d1 execute staffing-db --local --file=migrations/002_seed.sql
```

---

## üîß Outils de D√©veloppement

### Vite Dev Tools (Frontend)

Le dev server Vite inclut :
- ‚ö° Hot Module Replacement (HMR)
- üîç Error overlay
- üé® Tailwind CSS JIT

### Wrangler Dev Tools (API)

```bash
# Logs en temps r√©el
npx wrangler tail --local

# Avec filtres
npx wrangler tail --local --format=pretty
```

### Vitest UI (Tests)

```bash
# Ouvrir l'interface de tests
cd api && npm run test:ui

# Ou
cd frontend && npm run test:ui
```

Interface web interactive pour :
- Voir tous les tests
- Filtrer par nom/fichier
- Voir le coverage
- Debug interactif

### Playwright UI (E2E)

```bash
cd frontend
npm run test:e2e:ui
```

Interface pour :
- Voir les tests E2E
- Debug pas √† pas
- Voir les screenshots
- Time travel debugging

---

## üêõ Debugging

### API (Workers)

```typescript
// Dans votre code API
console.log('Debug:', { variable, data });

// Les logs apparaissent dans le terminal wrangler dev
```

### Frontend (React)

```typescript
// React DevTools
// Installer l'extension Chrome/Firefox

// Console browser
console.log('Debug component:', { props, state });
```

### VSCode Launch Config

Cr√©er `.vscode/launch.json` :

```json
{
  "version": "0.2.0",
  "configurations": [
    {
      "type": "node",
      "request": "launch",
      "name": "Debug API",
      "runtimeExecutable": "npm",
      "runtimeArgs": ["run", "dev"],
      "cwd": "${workspaceFolder}/api",
      "console": "integratedTerminal"
    },
    {
      "type": "chrome",
      "request": "launch",
      "name": "Debug Frontend",
      "url": "http://localhost:5173",
      "webRoot": "${workspaceFolder}/frontend/src"
    }
  ]
}
```

---

## üì¶ Variables d'Environnement

### API (.dev.vars)

```env
# Secrets
JWT_SECRET=your-jwt-secret-32-chars-min
GEMINI_API_KEY=your-gemini-key

# Config
NODE_ENV=development
LOG_LEVEL=debug
```

### Frontend (.env.local)

```env
# API URL
VITE_API_URL=http://localhost:8787

# Features flags
VITE_ENABLE_CHAT=true
VITE_ENABLE_MCP=true
```

---

## üîÑ Workflow D√©veloppement

### Cycle typique

```bash
# 1. D√©marrer l'environnement
npm run dev

# 2. Faire des modifications
# √âditer api/src/routes/consultants.ts

# 3. Tester automatiquement (watch mode)
cd api && npm run test:watch

# 4. V√©rifier en local
curl http://localhost:8787/api/consultants

# 5. Tester dans le navigateur
# Ouvrir http://localhost:5173

# 6. Commit quand tout est OK
git add .
git commit -m "feat: Add consultants endpoint"
```

### Hot Reload

- ‚úÖ **API** : wrangler dev recharge automatiquement
- ‚úÖ **Frontend** : Vite HMR ultra rapide
- ‚úÖ **Tests** : Vitest watch mode re-run automatique

---

## üì± Tester PWA en Local

### Mode PWA local

```bash
cd frontend

# Build PWA
npm run build

# Servir le build avec PWA
npx vite preview
```

Ouvrir http://localhost:4173 et installer la PWA :
- Chrome : Ic√¥ne "Install" dans la barre d'adresse
- Tester mode offline dans DevTools

---

## üéØ Commandes Utiles

### Installation

```bash
npm run bootstrap           # Installer tout
npm run clean              # Nettoyer node_modules
npm run clean:install      # Clean + r√©installer
```

### D√©veloppement

```bash
npm run dev                # D√©marrer tout
npm run dev:api            # API seule
npm run dev:frontend       # Frontend seul
npm run dev:seed           # Avec seed data
```

### Tests

```bash
npm run test:all           # Tous les tests
npm run test:api           # Tests API
npm run test:frontend      # Tests frontend
npm run test:coverage      # Coverage
npm run test:e2e           # E2E
```

### Base de donn√©es

```bash
npm run db:create          # Cr√©er DB locale
npm run db:migrate         # Appliquer migrations
npm run db:seed            # Charger seed data
npm run db:reset           # Reset complet
npm run db:query           # Requ√™te interactive
```

### Build

```bash
npm run build:all          # Build API + Frontend
npm run build:api          # Build API
npm run build:frontend     # Build Frontend
```

---

## ‚ùì Troubleshooting

### Port d√©j√† utilis√©

```bash
# API sur port 8787
lsof -ti:8787 | xargs kill -9

# Frontend sur port 5173
lsof -ti:5173 | xargs kill -9
```

### DB non trouv√©e

```bash
# Recr√©er la DB
cd api
rm -rf .wrangler
npx wrangler d1 execute staffing-db --local --file=migrations/001_initial.sql
```

### Secrets non charg√©s

```bash
# V√©rifier que .dev.vars existe
ls -la api/.dev.vars

# V√©rifier le contenu
cat api/.dev.vars
```

### Tests qui √©chouent

```bash
# R√©installer d√©pendances
npm run clean:install

# V√©rifier les versions
node --version  # 20+
npm --version   # 10+

# Relancer tests en verbose
cd api && npm test -- --reporter=verbose
```

### HMR ne fonctionne pas

```bash
# Red√©marrer Vite
cd frontend
pkill -f vite
npm run dev
```

---

## üéì Best Practices

### 1. Toujours tester en local avant de commiter

```bash
npm run test:all && git commit
```

### 2. Utiliser watch mode pendant le dev

```bash
npm run test:watch
```

### 3. Reset DB r√©guli√®rement

```bash
npm run db:reset
```

### 4. V√©rifier coverage

```bash
npm run test:coverage
# Coverage doit √™tre >= 85%
```

### 5. Tester en mode production localement

```bash
npm run build:all
npm run preview:all
```

---

## üöÄ Conclusion

D√©veloppement local simplifi√© :

‚úÖ **1 commande** pour tout d√©marrer
‚úÖ **Hot reload** sur tous les changements
‚úÖ **Tests rapides** avec watch mode
‚úÖ **DB locale** SQLite (pas besoin de Docker)
‚úÖ **Seed data** pour tester rapidement
‚úÖ **Debug facile** avec DevTools

**Pr√™t √† coder ! üéâ**

---

_Document cr√©√© : Janvier 2025_
_Version : 1.0_
_Projet : Staffing ESN_
